<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Âõç Lucky Draw Âõç</title>
    <style>
      :root {
        --accent: #6a0c0c;
        --bg: #fdf8f6;
        --card: #ffffff;
      }
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto,
          "Helvetica Neue", Arial;
        margin: 0;
        background: linear-gradient(#fdf5f4, #fff8f7);
        color: #0b1220;
      }
      .wrap {
        max-width: 980px;
        margin: 28px auto;
        padding: 18px;
      }
      header {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      h1 {
        margin: 0;
        font-size: 22px;
        font-family: Georgia, "Times New Roman", serif;
        letter-spacing: 0.6px;
      }
      .controls-summary {
        margin-top: 12px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      input[type="file"] {
        display: inline-block;
      }
      textarea {
        width: 420px;
        height: 120px;
        border-radius: 8px;
        border: 1px solid rgba(106, 12, 12, 0.08);
        padding: 8px;
        font-family: inherit;
      }
      .layout {
        display: grid;
        grid-template-columns: 240px 1fr;
        gap: 12px;
        margin-top: 18px;
      }
      .panel {
        background: var(--card);
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 6px 18px rgba(11, 18, 32, 0.06);
        border: 1px solid rgba(106, 12, 12, 0.06);
      }
      .list {
        max-height: 520px;
        overflow: auto;
      }
      .table-item {
        padding: 8px;
        border-radius: 8px;
        cursor: pointer;
        margin-bottom: 6px;
      }
      .table-item:hover {
        background: #fff6f6;
      }
      .table-item.active {
        background: linear-gradient(90deg, var(--accent), #8a1414);
        color: white;
      }
      .name-item {
        padding: 8px;
        border-radius: 8px;
        cursor: pointer;
        margin-bottom: 6px;
      }
      .name-item:hover {
        background: #fff7f7;
      }
      .name-item.selected {
        background: rgba(106, 12, 12, 0.06);
        border-left: 4px solid var(--accent);
      }

      .numbers-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 12px;
      }
      .card {
        width: 120px;
        height: 56px;
        border-radius: 8px;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        box-shadow: 0 6px 14px rgba(11, 18, 32, 0.06);
        transform-origin: center;
        backface-visibility: hidden;
      }

      /* digit-specific card (circle) */
      .digit-card {
        width: 72px;
        height: 72px;
        border-radius: 50%;
        background: white;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        font-size: 22px;
        box-shadow: 0 8px 18px rgba(11, 18, 32, 0.07);
        margin-right: 8px;
        transform-origin: center;
        backface-visibility: hidden;
      }

      /* spin reveal animation (appearance) */
      @keyframes spinReveal {
        0% {
          transform: rotateY(360deg) scale(0.2);
          opacity: 0;
        }
        60% {
          transform: rotateY(30deg) scale(1.08);
          opacity: 1;
        }
        100% {
          transform: rotateY(0deg) scale(1);
          opacity: 1;
        }
      }
      .digit-card.hidden {
        opacity: 0;
        transform: rotateY(360deg) scale(0.2);
      }
      .digit-card.visible {
        animation: spinReveal 0.5s cubic-bezier(0.2, 0.9, 0.3, 1) forwards;
      }

      /* small "spinner" text effect handled in JS (replacing content) */

      footer {
        margin-top: 18px;
        font-size: 13px;
        color: #3b4a5a;
      }
      .small {
        font-size: 13px;
        color: #546475;
      }

      /* Buttons */
      .btn {
        padding: 10px 14px;
        border-radius: 8px;
        background: var(--accent);
        color: white;
        border: 0;
        cursor: pointer;
      }
      .btn.secondary {
        background: #a63c3c;
      }
      .btn.green {
        background: #3a9f5a;
      }

      .btn.draw {
        min-width: 120px;
      }

      .set-title {
        margin: 12px 0 6px;
        color: var(--accent);
        font-weight: 700;
      }
      .set-block {
        padding: 10px;
        border-radius: 10px;
        background: linear-gradient(180deg, #fff, #fffaf9);
        border: 1px solid rgba(106, 12, 12, 0.04);
        margin-bottom: 10px;
      }

      /* .prize-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 10px 0;
        border-bottom: 1px solid rgba(0, 0, 0, 0.04);
      }
      .prize-left {
        display: flex;
        gap: 12px;
        align-items: center;
      } */
      .prize-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;

        padding: 14px 18px;
        margin: 8px 0;

        background: linear-gradient(135deg, #fff7f5 0%, #fffdfb 100%);
        border: 1px solid rgba(210, 180, 160, 0.25);
        border-radius: 14px;

        box-shadow: 0 3px 10px rgba(150, 90, 60, 0.08);

        transition: transform 0.2s ease, box-shadow 0.3s ease;
      }

      .prize-left {
        display: flex;
        align-items: center;
        gap: 14px;

        color: #6a0c0c; /* Deep wedding red */
        font-weight: 600;
        font-size: 1.05rem;
      }

      /* Optional: add a small gold shimmer icon */
      .prize-left .icon {
        width: 26px;
        height: 26px;
        border-radius: 50%;
        background: radial-gradient(circle, #f8e7bd, #e6c98f);
        box-shadow: 0 0 6px rgba(230, 200, 140, 0.6);
      }

      @media (max-width: 600px) {
        .digit-card {
          width: 58px;
          height: 58px;
          font-size: 18px;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <img
          src="./header.JPG"
          alt="Wedding Header"
          style="
            height: 100px;
            border-radius: 10px;
            margin-right: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
          "
        />
        <div>
          <h1>Lucky Draw ‚Äî Âõç ÊäΩÁçéÁ≥ªÁµ± Âõç</h1>
          <div
            style="
              font-size: 14px;
              color: #7a4b4b;
              font-family: Georgia, serif;
              margin-top: 4px;
            "
          >
            A special moment for our beloved guests
          </div>
        </div>
      </header>

      <!-- Guide block -->
      <div class="guide-block" style="margin-top: 18px">
        <div class="guide-title">üí° Â©öÁ¶ÆÊäΩÁçéÊïôÂ≠∏</div>
        <div class="guide-step">
          ‚ë†„Äå‰ªäÂ§©ÊØè‰ΩçË≥ìÂÆ¢ÈÉΩËÉΩÊäΩÂèñÂ∞àÂ±¨ÁöÑ10ÂÄãÂπ∏ÈÅãËôüÁ¢º„Äç„ÄÇ<br />Everyone gets 10
          lucky numbers today!
        </div>
        <div class="guide-step">
          ‚ë° ÈªûÈÅ∏Ê°åËôü ‚Üí ÈÅ∏ÊìáÊÇ®ÁöÑÂêçÂ≠ó„ÄÇ<br />Pick your table, choose your name.
        </div>
        <div class="guide-step">
          ‚ë¢ Êåâ‰∏ãÂúìÂΩ¢„ÄåDRAW„ÄçÊåâÈàï, ÊâÄÊúâÁçéËôüÊúÉÂÉèÁøªÁâå‰∏ÄÊ®£ÊóãËΩâÊè≠Êõâ„ÄÇ<br />Hit the
          round ‚ÄúDRAW‚Äù button ‚Äî watch your numbers flip like magic!
        </div>
      </div>

      <div class="layout" style="margin-top: 18px">
        <aside class="panel">
          <h3 style="margin-top: 0">Tables</h3>
          <div id="tablesList" class="list">
            No data loaded. Use Upload / Paste JSON to load assignments.
          </div>
        </aside>

        <main class="panel">
          <h3 style="margin-top: 0">Names & Draw</h3>
          <div id="namesList" class="list"></div>
          <div style="margin-top: 14px">
            <h4 id="selectedNameHeader">Select a name to reveal numbers</h4>
            <div id="drawControls" style="margin-top: 8px"></div>
            <div id="numbersArea"></div>
          </div>
        </main>
      </div>

      <footer>Good Luck!</footer>

      <!--  Winning Results Display -->
      <div
        style="
          margin: 16px 0;
          padding: 10px;
          background: #fffaf9;
          border: 1px solid rgba(106, 12, 12, 0.08);
          border-radius: 10px;
        "
      >
        <!-- Winning Results list shows here -->
        <div id="winningResultsContainer" style="margin-top: 16px"></div>
      </div>

      <!-- Settings dropdown -->
      <details style="margin-top: 12px">
        <!-- Search -->
        <div
          style="
            margin: 16px 0;
            padding: 10px;
            background: #fffaf9;
            border: 1px solid rgba(106, 12, 12, 0.08);
            border-radius: 10px;
          "
        >
          <div
            style="font-weight: 700; color: var(--accent); margin-bottom: 6px"
          >
            Search Number
          </div>
          <input
            id="searchInput"
            type="text"
            placeholder="Enter number (e.g. 1234)"
            style="
              padding: 8px;
              width: 160px;
              border-radius: 8px;
              border: 1px solid rgba(106, 12, 12, 0.2);
            "
          />
          <button id="searchBtn" class="btn" style="margin-left: 8px">
            Search
          </button>
          <div
            id="searchResults"
            style="margin-top: 10px; font-size: 14px; color: #7a4b4b"
          ></div>
        </div>
        <summary
          style="
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 8px;
            background: var(--accent);
            color: white;
            width: max-content;
            opacity: 0;
          "
        >
          Settings
        </summary>

        <div class="controls-summary" style="margin-top: 10px">
          <input id="fileInput" type="file" accept="application/json" />
          <button id="clearBtn" class="btn secondary">Clear stored data</button>
          <button id="downloadBtn" class="btn green">
            Download current JSON
          </button>
        </div>

        <div style="margin-top: 12px; display: flex; gap: 12px">
          <textarea
            id="pasteArea"
            placeholder='Or paste assignments JSON here then click "Load JSON"'
          ></textarea>
          <div style="display: flex; flex-direction: column; gap: 8px">
            <button id="loadPaste" class="btn">Load JSON</button>
            <div class="info">
              JSON structure expected: { "Name": {
              "table":"X","sets":[[...],[...]] }, ... }
            </div>
          </div>
        </div>

        <!-- Winning Results JSON editor -->
        <div
          style="
            margin-top: 14px;
            border-top: 1px dashed rgba(0, 0, 0, 0.04);
            padding-top: 12px;
          "
        >
          <div
            style="font-weight: 700; color: var(--accent); margin-bottom: 8px"
          >
            Winning Results (JSON)
          </div>
          <textarea
            id="winningResultsInput"
            placeholder='Paste winning results JSON here (array):\n[\n  { "price": 2000, "number": "????" },\n  { "price": 500, "number": "????" }\n]'
            style="width: 100%; height: 120px"
          ></textarea>
          <div style="display: flex; gap: 8px; margin-top: 8px">
            <button id="saveWinningBtn" class="btn">
              Save Winning Results
            </button>
            <button id="clearWinningBtn" class="btn secondary">
              Clear Winning Results
            </button>
            <button id="downloadWinningBtn" class="btn green">
              Download Winning JSON
            </button>
          </div>
          <div style="margin-top: 8px; color: #6b4b4b; font-size: 13px">
            Saved to localStorage key <code>winningResults</code>.
          </div>
        </div>
      </details>
    </div>

    <script>
      (function () {
        // Elements
        const fileInput = document.getElementById("fileInput");
        const pasteArea = document.getElementById("pasteArea");
        const loadPaste = document.getElementById("loadPaste");
        const tablesList = document.getElementById("tablesList");
        const namesList = document.getElementById("namesList");
        const numbersArea = document.getElementById("numbersArea");
        const selectedNameHeader =
          document.getElementById("selectedNameHeader");
        const drawControls = document.getElementById("drawControls");
        const clearBtn = document.getElementById("clearBtn");
        const downloadBtn = document.getElementById("downloadBtn");

        const winningResultsInput = document.getElementById(
          "winningResultsInput"
        );
        const saveWinningBtn = document.getElementById("saveWinningBtn");
        const clearWinningBtn = document.getElementById("clearWinningBtn");
        const downloadWinningBtn =
          document.getElementById("downloadWinningBtn");
        const winningResultsContainer = document.getElementById(
          "winningResultsContainer"
        );

        const searchInput = document.getElementById("searchInput");
        const searchBtn = document.getElementById("searchBtn");
        const searchResults = document.getElementById("searchResults");

        // State
        let data = null; // assignments
        let tables = [];
        let currentTable = null;
        let currentName = null;

        // Timing specification (final confirmed): reveal timeline (ms)
        const revealDelays = [2000, 2000, 2000, 2000]; // reveal1 at 2s, reveal2 at 4s, reveal3 at 7s, reveal4 at 7s

        // -------------------------
        // Assignments loading / saving
        // -------------------------
        function loadAssignments(obj) {
          data = obj;
          localStorage.setItem("assignments", JSON.stringify(data));
          buildTables();
        }

        const stored = localStorage.getItem("assignments");
        if (stored) {
          try {
            loadAssignments(JSON.parse(stored));
          } catch (e) {
            console.warn("Invalid stored JSON");
          }
        } else {
          tablesList.innerHTML =
            "No data loaded. Use Upload / Paste JSON to load assignments.";
        }

        fileInput.addEventListener("change", (ev) => {
          const f = ev.target.files[0];
          if (!f) return;
          const reader = new FileReader();
          reader.onload = () => {
            try {
              const parsed = JSON.parse(reader.result);
              loadAssignments(parsed);
              alert("Assignments JSON loaded successfully");
            } catch (e) {
              alert("Invalid JSON file");
            }
          };
          reader.readAsText(f);
        });

        loadPaste.addEventListener("click", () => {
          const txt = pasteArea.value.trim();
          if (!txt) return alert("Paste JSON into the box first");
          try {
            const parsed = JSON.parse(txt);
            loadAssignments(parsed);
            alert("Assignments JSON loaded");
          } catch (e) {
            alert("Invalid JSON");
          }
        });

        clearBtn.addEventListener("click", () => {
          if (!confirm("Clear stored assignments?")) return;
          localStorage.removeItem("assignments");
          data = null;
          tablesList.innerHTML =
            "No data loaded. Use Upload / Paste JSON to load assignments.";
          namesList.innerHTML = "";
          numbersArea.innerHTML = "";
          selectedNameHeader.textContent = "Select a name to reveal numbers";
          drawControls.innerHTML = "";
        });

        downloadBtn.addEventListener("click", () => {
          if (!data) return alert("No data loaded");
          const blob = new Blob([JSON.stringify(data, null, 2)], {
            type: "application/json",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "final_assignments.json";
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        });

        // Build tables
        function buildTables() {
          if (!data) {
            tablesList.innerHTML = "No data loaded.";
            return;
          }
          const map = {};
          for (const [name, entry] of Object.entries(data)) {
            const table = String(entry.table ?? entry.table_number ?? "N/A");
            if (!map[table]) map[table] = [];
            map[table].push(name);
          }
          tables = Object.keys(map).sort((a, b) => {
            const an = Number(a),
              bn = Number(b);
            if (!Number.isNaN(an) && !Number.isNaN(bn)) return an - bn;
            return a.localeCompare(b);
          });

          tablesList.innerHTML = "";
          tables.forEach((t) => {
            const el = document.createElement("div");
            el.className = "table-item";
            el.textContent = `${t} ‚Äî ${map[t].length} name(s)`;
            el.addEventListener("click", () => {
              selectTable(t, map[t]);
              highlightTable(el);
            });
            tablesList.appendChild(el);
          });

          if (tables.length) selectTable(tables[0], map[tables[0]]);
        }

        function highlightTable(el) {
          Array.from(tablesList.children).forEach((c) =>
            c.classList.remove("active")
          );
          el.classList.add("active");
        }

        function selectTable(table, names) {
          currentTable = table;
          currentName = null;
          namesList.innerHTML = "";
          names
            .sort((a, b) => a.localeCompare(b))
            .forEach((n) => {
              const div = document.createElement("div");
              div.className = "name-item";
              div.textContent = n;
              div.addEventListener("click", () => selectName(n, div));
              namesList.appendChild(div);
            });
          numbersArea.innerHTML = "";
          selectedNameHeader.textContent = `Select a name at table ${table}`;
          drawControls.innerHTML = "";
        }

        function selectName(name, el) {
          currentName = name;
          Array.from(namesList.children).forEach((c) =>
            c.classList.remove("selected")
          );
          el.classList.add("selected");
          selectedNameHeader.textContent = `${name}`;
          numbersArea.innerHTML = "";
          drawControls.innerHTML = "";
          const entry = data[name];
          if (!entry) {
            numbersArea.textContent = "No data for this name";
            return;
          }

          const drawBtn = document.createElement("button");
          drawBtn.textContent = "Draw";
          drawBtn.className = "btn draw draw-circle";
          drawControls.appendChild(drawBtn);
          drawBtn.addEventListener("click", () => {
            drawControls.innerHTML = "";
            revealNumbers(name);
          });
        }

        // revealNumbers (individual guest 10 numbers) - unchanged behavior
        function revealNumbers(name) {
          const entry = data[name];
          if (!entry) {
            numbersArea.textContent = "No data for this name";
            return;
          }
          const allNums = (entry.sets || []).flat();
          const chunked = [];
          for (let i = 0; i < allNums.length; i += 10)
            chunked.push(allNums.slice(i, i + 10));
          numbersArea.innerHTML = "";

          chunked.forEach((set, si) => {
            const title = document.createElement("h4");
            title.className = "set-title";
            title.textContent = `Set ${si + 1}`;
            numbersArea.appendChild(title);

            const block = document.createElement("div");
            block.className = "set-block";
            numbersArea.appendChild(block);

            const grid = document.createElement("div");
            grid.className = "numbers-grid";
            block.appendChild(grid);

            set.forEach((num, idx) => {
              const card = document.createElement("div");
              card.className = "card hidden";
              card.textContent = "----";
              grid.appendChild(card);

              setTimeout(() => {
                card.classList.remove("hidden");
                card.classList.add("visible");
                let spins = 15 + Math.floor(Math.random() * 10);
                const spinInterval = setInterval(() => {
                  card.textContent = Math.floor(1000 + Math.random() * 9000);
                  spins--;
                  if (spins <= 0) {
                    clearInterval(spinInterval);
                    card.textContent = num;
                    card.classList.add("revealed");
                  }
                }, 60);
              }, 200 + si * 800 + idx * 150);
            });
          });
        }

        // -------------------------
        // Search
        // -------------------------
        if (searchBtn) {
          searchBtn.addEventListener("click", () => {
            const q = searchInput.value.trim();
            if (!q || q.length < 1) {
              searchResults.textContent = "Please enter a number.";
              return;
            }
            searchNumber(q);
          });
        }

        function searchNumber(num) {
          if (!data) {
            searchResults.textContent = "No data loaded.";
            return;
          }
          const matches = [];
          for (const [name, entry] of Object.entries(data)) {
            if (!entry.sets) continue;
            for (let i = 0; i < entry.sets.length; i++) {
              const set = entry.sets[i];
              if (set.includes(parseInt(num)))
                matches.push({
                  name,
                  table: entry.table ?? "N/A",
                  setIndex: i + 1,
                });
            }
          }
          if (matches.length === 0) {
            searchResults.innerHTML = `<span style="color:#a63c3c">No matches found.</span>`;
            return;
          }
          let html = `<div style="font-weight:700; margin-bottom:6px;">Matched Guest(s):</div>`;
          html += matches
            .map(
              (m) =>
                `<div style="padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.06);"><strong>${m.name}</strong> (Table ${m.table}) ‚Äî Set ${m.setIndex}</div>`
            )
            .join("");
          searchResults.innerHTML = html;
        }

        // -------------------------
        // Winning Results (prizes)
        // -------------------------
        function loadWinningResultsFromStorage() {
          const raw = localStorage.getItem("winningResults");
          if (!raw) {
            winningResultsInput.value = "";
            renderWinningResults([]);
            return;
          }
          try {
            const parsed = JSON.parse(raw);
            winningResultsInput.value = JSON.stringify(parsed, null, 2);
            renderWinningResults(parsed);
          } catch (e) {
            winningResultsInput.value = "";
            renderWinningResults([]);
          }
        }

        saveWinningBtn.addEventListener("click", () => {
          const txt = winningResultsInput.value.trim();
          if (!txt)
            return alert("Paste winning results JSON into the box first");
          try {
            const parsed = JSON.parse(txt);
            if (!Array.isArray(parsed)) {
              alert("Winning results JSON must be an array of objects");
              return;
            }
            parsed.forEach((p) => {
              p.number = String(p.number);
            });
            localStorage.setItem("winningResults", JSON.stringify(parsed));
            // when saving new winning results, clear previous prizeResults so they start fresh
            localStorage.removeItem("prizeResults");

            renderWinningResults(parsed);
            alert("Winning results saved (previous results cleared)");
          } catch (e) {
            alert("Invalid JSON");
          }
        });

        clearWinningBtn.addEventListener("click", () => {
          if (
            !localStorage.getItem("winningResults") &&
            !localStorage.getItem("prizeResults")
          )
            return;
          if (
            !confirm(
              "Clear saved winning results and previous prize results? This will reset prize UI to [----]."
            )
          )
            return;
          localStorage.removeItem("winningResults");
          localStorage.removeItem("prizeResults");
          winningResultsInput.value = "";
          renderWinningResults([]);
        });

        downloadWinningBtn.addEventListener("click", () => {
          const raw = localStorage.getItem("winningResults");
          if (!raw) return alert("No winning results saved");
          const blob = new Blob([raw], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "winning_results.json";
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        });

        // prizeResults helpers (save/load)
        function loadPrizeResultsFromStorage() {
          const raw = localStorage.getItem("prizeResults");
          if (!raw) return {};
          try {
            return JSON.parse(raw);
          } catch {
            return {};
          }
        }
        function savePrizeResult(index, numberStr) {
          const obj = loadPrizeResultsFromStorage();
          obj[index] = String(numberStr);
          localStorage.setItem("prizeResults", JSON.stringify(obj));
        }

        // collect all assigned numbers from assignments
        function collectAssignedNumbers() {
          const arr = [];
          if (!data) return arr;
          for (const [name, entry] of Object.entries(data)) {
            if (!entry.sets) continue;
            for (const set of entry.sets) {
              for (const val of set) arr.push(String(val));
            }
          }
          return arr;
        }

        // Core: renderWinningResults
        function renderWinningResults(list) {
          winningResultsContainer.innerHTML = "";
          if (!list || !list.length) {
            winningResultsContainer.innerHTML = `<div style="color:#6b4b4b">Thank you!</div>`;
            return;
          }

          const savedPrizeResults = loadPrizeResultsFromStorage();

          list.forEach((item, idx) => {
            const row = document.createElement("div");
            row.className = "prize-row";

            const left = document.createElement("div");
            left.className = "prize-left";
            const label = document.createElement("div");
            label.style.fontWeight = "700";
            label.textContent = `Price - ${item.price}`;

            const digitsWrap = document.createElement("div");
            digitsWrap.className = "digit-row";
            digitsWrap.id = `winning-digits-${idx}`;

            // Determine display value: if savedPrizeResults has value, show digits; else show placeholders
            const saved = savedPrizeResults[idx];
            // const chosen = saved ?? String(item.number ?? "").slice(0, 4);
            const chosen = saved != null ? saved : "";
            const chars = chosen ? chosen.split("") : [];

            // build 4 digit-cards
            for (let i = 0; i < 4; i++) {
              const d = document.createElement("div");
              d.className = "digit-card";
              d.textContent = chars[i] ? chars[i] : "----";
              digitsWrap.appendChild(d);
            }

            left.appendChild(label);
            left.appendChild(digitsWrap);

            const btn = document.createElement("button");
            btn.className = "btn draw";
            btn.dataset.idx = idx;
            btn.textContent = saved ? "Re-draw" : "DRAW";

            // DRAW / REDRAW handler according to the final spec
            btn.addEventListener("click", () => {
              btn.disabled = true;

              // ALL digits should spin together first (replace content with random digits rapidly)
              const digitsEls = digitsWrap.children;
              // initialize to placeholders (visible)
              digitsWrap.innerHTML = "";
              for (let i = 0; i < 4; i++) {
                const ph = document.createElement("div");
                ph.className = "digit-card hidden";
                ph.textContent = "----";
                digitsWrap.appendChild(ph);
              }
              // animate in
              setTimeout(() => {
                Array.from(digitsWrap.children).forEach((el) => {
                  el.classList.remove("hidden");
                  el.classList.add("visible");
                });
              }, 40);

              // Start spinning (random digits) for all cells
              const spinIntervals = [];
              setTimeout(() => {
                for (let i = 0; i < 4; i++) {
                  const el = digitsWrap.children[i];
                  spinIntervals[i] = setInterval(() => {
                    el.textContent = String(Math.floor(Math.random() * 10));
                  }, 60);
                }
              }, 120); // small delay to ensure visible animation started

              // Decide final chosenNumber:
              const assigned = collectAssignedNumbers();
              let finalNumberStr = "";
              // If button was "DRAW" -> show configured prize number
              // If button was "Re-draw" -> pick random from assignments (if available), otherwise fallback to configured
              if (btn.textContent === "DRAW" && item.number !== "????") {
                finalNumberStr = String(item.number ?? "");
              } else {
                if (assigned.length > 0)
                  finalNumberStr =
                    assigned[Math.floor(Math.random() * assigned.length)];
                else finalNumberStr = String(item.number ?? "");
              }
              finalNumberStr = String(finalNumberStr);
              // ensure at least 4 length (pad with spaces) and take first 4 chars
              while (finalNumberStr.length < 4)
                finalNumberStr = finalNumberStr + " ";
              const finalChars = finalNumberStr.split("").slice(0, 4);

              // Reveal schedule: based on your final spec:
              // reveal1 at 2000ms, reveal2 at 4000ms, reveal3 at 7000ms, reveal4 at 7000ms (same time as 3)
              // We'll use relative times from "start of spin" (t0)
              const t0 = Date.now();
              const revealTimes = [
                t0 + revealDelays[0],
                t0 + (revealDelays[0] + revealDelays[1]),
                t0 + (revealDelays[0] + revealDelays[1] + revealDelays[2]),
                t0 +
                  (revealDelays[0] +
                    revealDelays[1] +
                    revealDelays[2] +
                    revealDelays[3]),
              ];
              // But revealDelays is [2000,2000,3000,0]; so revealTimes produce 2s,4s,7s,7s - correct.

              // schedule reveals
              revealTimes.forEach((rt, i) => {
                const delay = Math.max(0, rt - Date.now());
                setTimeout(() => {
                  // stop the spinner for this digit (clear interval) and set final
                  clearInterval(spinIntervals[i]);
                  const el = digitsWrap.children[i];
                  if (el) {
                    el.textContent =
                      finalChars[i] !== undefined ? finalChars[i] : " ";
                    el.classList.add("revealed");
                  }
                }, delay);
              });

              // After final reveal time (use last reveal time), set button to Re-draw and save result
              const totalRevealTime =
                revealTimes[revealTimes.length - 1] - Date.now();
              setTimeout(() => {
                // ensure all intervals cleared
                spinIntervals.forEach((iv) => clearInterval(iv));
                btn.disabled = false;
                btn.textContent = "Re-draw";
                // save chosen number (string) to prizeResults storage
                savePrizeResult(idx, finalNumberStr);
              }, totalRevealTime + 50); // small buffer
            });

            row.appendChild(left);
            row.appendChild(btn);
            winningResultsContainer.appendChild(row);
          });
        }

        // Initial load of winning results and UI state
        (function initWinningUI() {
          const raw = localStorage.getItem("winningResults");
          if (!raw) {
            renderWinningResults([]);
            return;
          }
          try {
            const parsed = JSON.parse(raw);
            winningResultsInput.value = JSON.stringify(parsed, null, 2);
            renderWinningResults(parsed);
          } catch (e) {
            renderWinningResults([]);
          }
        })();

        // expose load function for manual refresh if needed
        window._reloadWinningUI = function () {
          const raw = localStorage.getItem("winningResults");
          if (!raw) return renderWinningResults([]);
          try {
            renderWinningResults(JSON.parse(raw));
          } catch {
            renderWinningResults([]);
          }
        };

        // end IIFE
      })();
    </script>
  </body>
</html>
